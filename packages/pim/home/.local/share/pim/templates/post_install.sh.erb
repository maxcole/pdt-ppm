#!/bin/bash
# Post-installation script
# Generated by pim (Product Image Manager)
#
# This script runs after the base system is installed.
# It can be used for additional configuration, package installation, etc.

set -e

USERNAME="<%= username || 'user' %>"
HOSTNAME="<%= hostname || 'debian' %>"

echo "=== Post-installation script starting ==="
echo "Hostname: $HOSTNAME"
echo "Username: $USERNAME"

# Update package lists
apt-get update

<% if additional_packages %>
# Install additional packages
echo "Installing additional packages..."
apt-get install -y <%= additional_packages %>
<% end %>

<% if authorized_keys_url %>
# Setup SSH authorized keys
echo "Setting up SSH keys..."
mkdir -p /home/$USERNAME/.ssh
curl -fsSL "<%= authorized_keys_url %>" -o /home/$USERNAME/.ssh/authorized_keys
chmod 700 /home/$USERNAME/.ssh
chmod 600 /home/$USERNAME/.ssh/authorized_keys
chown -R $USERNAME:$USERNAME /home/$USERNAME/.ssh
<% end %>

<% if disable_password_auth %>
# Disable password authentication for SSH
echo "Disabling SSH password authentication..."
sed -i 's/#PasswordAuthentication yes/PasswordAuthentication no/' /etc/ssh/sshd_config
sed -i 's/PasswordAuthentication yes/PasswordAuthentication no/' /etc/ssh/sshd_config
systemctl restart sshd || true
<% end %>

<% if setup_docker %>
# Install Docker
echo "Installing Docker..."
curl -fsSL https://get.docker.com | sh
usermod -aG docker $USERNAME
<% end %>

<% if custom_script %>
# Custom script
echo "Running custom script..."
<%= custom_script %>
<% end %>

echo "=== Post-installation complete ==="
